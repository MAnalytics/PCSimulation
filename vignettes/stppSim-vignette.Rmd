---
title: "An R package for synthesizing spatiotemporal point patterns for social and life science research - A user guide"

author: |
  | Monsuru Adepeju^[Big Data Centre, Manchester Metropolitan University, Manchester, M156BH, UK, m.adepeju@mmu.ac.uk]
  | Meng Le Zhang^[Interdisciplinary Centre of Social Sciences, University of Sheffield, S14DP, UK, mengle.zhang@sheffield.ac.uk] 
  
date: |
  | `Date:`
  | ``r Sys.Date()``

#output:
  #pdf_vignette
  
output:
  pdf_document

urlcolor: blue

toc:
  true

number_sections: 
  yes
    
linestretch: 
  1.5
  
fontsize: 
  16pt

#header-includes:
 # - \usepackage{leading}
  #- \leading{18}
  
#dev: png
#output:
  #word_document: default
  #always_allow_html: yes
#  pdf_document: default
always_allow_html: yes
#fig_caption: yes
bibliography: references.bib

abstract: Generates artificial spatio-temporal point patterns (stpp) through the integration of microsimulation and agent-based models. Allows a user to define the movement characteristics of a set of "walkers" (agents) whose interactions with the environment give rise to new events across the space. The ST patterns from the accumulation of events can be quantified for model testing and evaluation. With increasingly limited availability of fine-grained spatially and temporally stamped point data, `stppSim` provides an alternative source of datasets for wide range of fields in social and life sciences.

vignette: >
  %\VignetteIndexEntry{An R package for synthesizing spatiotemporal point patterns for social and life science research - A user guide}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r functions, include=FALSE}
# A function for captioning and referencing images
fig <- local({
  i <- 0
  ref <- list()
  list(
    cap=function(refName, text) {
      i <<- i + 1
      ref[[refName]] <<- i
      paste("Figure ", i, ": ", text, sep="")
    },
    ref=function(refName) {
      ref[[refName]]
    })
})
```

## Introduction

In many context, access to fine-grained spatiotemporal (ST) point data have been severely restricted due to privacy concerns. As an alternative, synthesized data which mimic the real-life data have been utilized. The `R-stppSim` package is designed for generating synthesized fine-grained ST point data within a defined landscape coverage. The package combines microsimulation and agent-based models, allowing a user to construct the movement characteristics of a set of `walkers` (i.e., agents) across the space. A walker can be interpreted in a wide variety of ways depending on the application field. For example, a walker could be a human offender (crime analysis), a foraging animal (Wildlife studies) or a carrier in epidemiological studies). The interaction between the walkers and the environment give rise to new events whose patterns are measurable at both the local and global level for model testing and evaluation.

The `stpp` can be synthesized by using either of two functions: `psim_artif` and `psim_real`. The `psim_artif` synthesizes `stpp` from scratch. That is, given a landscape, the movement characteristics of the `walkers` as well as the properties of the landscape are defined by the user. On the other hand, `psim_real` synthesizes `stpp` from a sample (or a sparse version) of a real data. The function first learns (or extracts) the ST characteristics of the sample data, and utilizes these characteristics to calibrate the behaviours of the `walkers` and certain properties of the landscape. The potential application fields for `stppSim` include criminology, epidemiology, and wildlife science.

## Simulation Parameters

The simulation parameters are in relation to three items, namely; the '`walkers`', the `landscape` (spatial), and `long-term trend` (temporal). The interactions between these three result in the advent of new point events. The parameters are described as follow: 

### Walkers.

The walkers are defined primarily by the following characteristics:

* ***Origins*** - The walkers emanate from a set of origins distributed randomly across the landscape or origins determined from a sample real point data. Origins are supplied as a set of `xy` coordinates (`coords`). In the analysis of human offenders, origins are synonymous to their residences. The spatial pattern of `origins` can be either of two concentration type. First, is `nucleated` in which all origins concentrate around one single major focal point, and the second, `dispersed` in which there is no single focus.
The concentration of origin across the landscape can be nucleated or dispersed
* ***Movement*** - Walkers a capable of moving in any direction and also aware of restrictions around them. The movements are controlled primarily by an in-built (stochastic) transition matrix configured for two transitional states, namely; an `exploratory` state, in which a walker is merely exploring the environment and a `performative` state in which a walker is performing an action other than exploring.
* ***Spatial range*** - A distance threshold that defines the perception range of a walker at any location. The perception range is generally updated as a walker moves to a new location.
* ***Steps*** - The maximum step taken by a walkers as they move from location to another. This impacts the spread of the resulting point patterns across the space. The step should be carefully defined, especially, when the movement is restricted to narrow paths, such as route network as a restriction feature. 


### Landscape

The landscape  are key properties of a landscape:

* ***Boundary*** - The extent of a landscape is defined by a polygon shapefile (`poly`) or by the land coverage of the sample point data.
* ***Restrictions*** - These are supplied as a raster layer. A restriction map would normally show the boundary outside of which the restriction value is `1` representing the maximum restriction. In other words, events cannot occur outside the boundary. When additional features, such as urban structures or land use, are added, they may carry restriction values in the range of [0-1].
* ***Focal points*** - These are synonymous to city/town centres (in urban studies) within/around which events are relatively higher in concentration compared to the rest of the city. The locations present more opportunities to event occurrences. 


### Long-term trend

* ***global pattern*** - this anchors the variability in the magnitude of events over time. Its composed of two components: `long-term trend` and `seasonality`. The long-term trend can be `stable`, `increasing` or `decreasing`. The `seasonality` is controlled by the parameter `first_pDate` indicating the first seasonal peak` of a time series. A `90` day first peak implies a seasonal cycle of 180 days.
* ***time bin*** - only daily time bin is implemented here.. ne time bin is implemented here
* ***Proportional ratios*** - This is the the

## Installation of `stppSim`

From an R console, type:

```{r eval=FALSE, message=FALSE, warning=FALSE}
#install.packages("stppSim")
library(stppSim)
```

To install the developmental version of the package, use the follow codes:

```{r eval=FALSE, message=FALSE, warning=FALSE}
#install.packages("stppSim")
remotes::install_github("MAnalytics/stppSim")
library(stppSim)
```

Note: `remotes` is an extra package that needed to be installed prior to the running of this code. 


## Synthesizing `stpp` from scratch

The following steps demonstrate how `stppSim` package can be used to simulate spatiotemporal point patterns:

To simulate `stpp`, key parameters include the `n_events` denoting the number of events to generate. It is however, advisable to supply a vector with different values

#### On an unrestricted landscape

```{r eval=FALSE, message=FALSE, warning=FALSE}
data(camden_boundary)
data(landuse)
artif_stpp <- psim_artif(n_events=200, start_date = "2021-01-01",
poly=camden_boundary, n_origin=50, resistance_feat = landuse,
field = "rValue1",
n_foci=5, foci_separation = 10, conc_type = "dispersed",
p_ratio = 20, s_threshold = 50, step_length = 20,
trend = "stable", first_pDate=NULL,
slope = NULL,show.plot=FALSE, show.data=FALSE)
```

The computational time:

#### On a restricted landscape
```{r eval=FALSE, message=FALSE, warning=FALSE}
data(camden_boundary)
data(landuse)
artif_stpp <- psim_artif(n_events=200, start_date = "2021-01-01",
poly=camden_boundary, n_origin=50, resistance_feat = landuse,
field = "rValue1",
n_foci=5, foci_separation = 10, conc_type = "dispersed",
p_ratio = 20, s_threshold = 50, step_length = 20,
trend = "stable", first_pDate=NULL,
slope = NULL,show.plot=FALSE, show.data=FALSE)
```

Computational time

#plotting the results


### stpp simulation from a sample dataset

Here, we are going to use a small sample of a data to simulate the full dataset. We will then compare the real full data with the simulated data.

```{r eval=FALSE, message=FALSE, warning=FALSE}
data(camden_crimes)
#subset 'theft' crime
theft <- camden_crimes[which(camden_crimes$type ==
"Theft"),]
#specify the proportion of full data to use
sample_size <- 0.2
set.seed(1000)
dat_sample <- theft[sample(1:nrow(theft),
round((sample_size * nrow(theft)), digits=0),
replace=FALSE),1:3]
#plot(dat_sample$x, dat_sample$y) #preview
result <- psim_real(n_events=2000, ppt=dat_sample,
start_date = NULL, poly = NULL, s_threshold = NULL,
step_length = 20, n_origin=50, resistance_feat, field=NA,
p_ratio=20, crsys = "EPSG:27700")
```



We are going to compare real (full) data and the simulated one in terms of their spatial and temporal characteristics. Recall that a user would have no idea of case count. So, the number to simulate is left to the discretion of the use. You can infer the potential size from any available data from previus years.


Note:
applications. Certain areas, only sparse data are availabe;... 
