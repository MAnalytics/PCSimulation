---
title: "An R package for synthesizing spatiotemporal point patterns for social and life science research - A user guide"

author: |
  | Monsuru Adepeju^[Big Data Centre, Manchester Metropolitan University, Manchester, M156BH, UK, m.adepeju@mmu.ac.uk]
  | Meng Le Zhang^[Interdisciplinary Centre of Social Sciences, University of Sheffield, S14DP, UK, mengle.zhang@sheffield.ac.uk] 
  
date: |
  | `Date:`
  | ``r Sys.Date()``

#output:
  #pdf_vignette
  
output:
  pdf_document

urlcolor: blue

toc:
  true

number_sections: 
  yes
    
linestretch: 
  1.5
  
fontsize: 
  16pt

#header-includes:
 # - \usepackage{leading}
  #- \leading{18}
  
#dev: png
#output:
  #word_document: default
  #always_allow_html: yes
#  pdf_document: default
always_allow_html: yes
#fig_caption: yes
bibliography: references.bib

abstract: Generates artificial spatio-temporal (ST) point 
  patterns through the integration of microsimulation and 
  agent-based models. Allows a user to define the behaviours 
  of a set of "walkers" (agents, objects, persons, etc,) whose
  interactions with the spatial (landscape) and the temporal 
  domains produce new point events. The resulting ST patterns
  from the point cloud can be measured and utilized for spatial 
  and/or temporal model testings and evaluations. 
  With increasingly limited availability of fine-grained 
  spatially and temporally stamped point data, the package 
  provides an alternative source of data for a wide range of 
  fields in social and life sciences.

vignette: >
  %\VignetteIndexEntry{An R package for synthesizing spatiotemporal point patterns for social and life science research - A user guide}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r functions, include=FALSE}
# A function for captioning and referencing images
fig <- local({
  i <- 0
  ref <- list()
  list(
    cap=function(refName, text) {
      i <<- i + 1
      ref[[refName]] <<- i
      paste("Figure ", i, ": ", text, sep="")
    },
    ref=function(refName) {
      ref[[refName]]
    })
})
```

## Introduction

In many research context, access to fine-grained spatiotemporal (ST) point data have been severely restricted due to privacy concerns. The `R-stppSim` package has been designed to address this challenge by presenting a framework that is capable of mimicking a real-life data through the integration of microsimulation and agent-based techniques. The framework comprises a set of 'walkers' (agents, objects, persons, etc.) with modifiable movement and interaction properties, constructed within specified spatial and temporal domains. As the framework produces new point events, in accordance with a user setting, a defined ST pattern emerges at both the local and global levels.

The package contains two main functions for synthesizing new datasets; (i) `psim_artif` and (ii) `psim_real`. The `psim_artif` synthesizes ST point patterns from scratch. That is, the simulation is entirely based on a user's setting. On the other hand, `psim_real` synthesizes ST point patterns based on a sample (or a sparse version) of a real data. The function first learns (or extracts) the certain ST characteristics of the sample data, and extrapolates to produce full dataset. The potential application fields for `stppSim` include criminology, epidemiology, and wildlife science.

## Simulation Parameters

The simulation parameters are in relation to three items, namely; the '`walkers`', the `landscape` (spatial), and the `temporal` components. The parameters are described as follow: 

### Walkers.

The walkers are defined primarily by the following characteristics:

* ***Origins*** - The walkers emanate from a set of origins distributed randomly across the landscape or origins determined from a sample of real point data. Origins are provided as a set of `xy` coordinates (`coords`). In the analysis of human offenders, as an example, origins are synonymous to offender residences. The spatial pattern of `origins` can be either of two concentration types. First, is the `nucleated` in which all origins concentrate around one focal point, and the second, the `dispersed` in which there is no focal point.
* ***Movement*** - Walkers are configured to move in any direction and also be aware of restrictions on their path. The movements are controlled primarily by an in-built transition matrix (TM) comprising two transitional states, namely; an `exploratory` state (in which a walker is merely exploring the environment) and a `performative` state (in which a walker is performing an action). The stochastic properties of the TM ensure variations in the behavioural patterns amongst the walkers.
* ***Spatial threshold*** - A distance that defines the perception range of a walker at any location. The perception range is generally updated as a walker moves to a new location.
* ***Steps*** - The maximum step taken by a walkers as they move from one location to another. This impacts the spread of point patterns across the space. The `steps` should be carefully defined, especially, when movements of walkers are restricted to narrow paths, such as route network, in which case the `steps` should be smaller than the path widths. 
* ***Proportional ratios*** - Controls the percentage of total events emanating from a small number of origins (i.e., most active origins). 


### Landscape

The followings are key properties of a landscape:

* ***Boundary*** - Defined by a polygon shapefile (`poly`) or by the spatial extent of a sample point data.
* ***Restrictions*** - Provided as a raster layer. A restriction map shows the boundary outside of which the restriction value is usually `1`, representing the maximum restriction. That is, events are not allowed to occur outside the boundary. When a restriction map contains additional features, such as land use or urban structures, the restriction values may vary from one feature type to another in the range of [0-1].
* ***Focal points*** - Synonymous to city/town centres (in urban studies) which usually contain relatively higher concentration of events. Focal points present more opportunities to event occurrences. 


### Temporal pattern

The followings define the temporal patterns:

* ***global pattern*** - Defines the temporal variation in events over time. Its composed of two aspects: `long-term trend` and `seasonality`. The long-term trend can be `stable`, `increasing` or `decreasing`. The `seasonality` is controlled by the parameter; `first_pDate`, indicating the date of the first seasonal peak of a time series. A `90` day first peak implies a seasonal cycle of `180` days.
* ***time bin*** - Time range to reset all walkers.


## Installation of `stppSim`

From an R console, type:

```{r eval=FALSE, message=FALSE, warning=FALSE}
#install.packages("stppSim")
library(stppSim)
```

To install the developmental version of the package, type:

```{r eval=FALSE, message=FALSE, warning=FALSE}
#install.packages("stppSim")
remotes::install_github("MAnalytics/stppSim")
library(stppSim)
```

Note: `remotes` is an extra package that needed to be installed prior to the running of this code. 


## Synthesizing `stpp` from scratch

To simulate point patterns from scratch, note the argument `n_events=` to specify number of point events to generate. It is recommended that a vector of values is provided, such as, `n_events = c(200, 500, 1000, 2000, ...)`. This gives a user the opportunity to explore different data sizes for their research. Note: the specification of `n_events` has little or no
impacts on the computational time (See the manual for further details on the computational time). 

#### On an unrestricted landscape

```{r eval=FALSE, message=FALSE, warning=FALSE}
#Using datasets that come with the package;
data(camden_boundary)
data(landuse)
#defining data sizes to simulate
size = c(200, 500, 1000, 2000, 5000)

artif_stpp <- psim_artif(n_events=200, start_date = "2021-01-01",
  poly=camden_boundary, n_origin=50, resistance_feat = landuse,
  field = "rValue1",
  n_foci=5, foci_separation = 10, conc_type = "dispersed",
  p_ratio = 20, s_threshold = 50, step_length = 20,
  trend = "stable", first_pDate=NULL,
  slope = NULL,show.plot=FALSE, show.data=FALSE)
```

#### On a restricted landscape

```{r eval=FALSE, message=FALSE, warning=FALSE}
data(camden_boundary)
data(landuse)
artif_stpp <- psim_artif(n_events=200, start_date = "2021-01-01",
poly=camden_boundary, n_origin=50, resistance_feat = landuse,
field = "rValue1",
n_foci=5, foci_separation = 10, conc_type = "dispersed",
p_ratio = 20, s_threshold = 50, step_length = 20,
trend = "stable", first_pDate=NULL,
slope = NULL,show.plot=FALSE, show.data=FALSE)
```

Computational time

#plotting the results


### stpp simulation from a sample dataset

Here, we are going to use a small sample of a data to simulate the full dataset. We will then compare the real full data with the simulated data.

```{r eval=FALSE, message=FALSE, warning=FALSE}
data(camden_crimes)
#subset 'theft' crime
theft <- camden_crimes[which(camden_crimes$type ==
"Theft"),]
#specify the proportion of full data to use
sample_size <- 0.2
set.seed(1000)
dat_sample <- theft[sample(1:nrow(theft),
round((sample_size * nrow(theft)), digits=0),
replace=FALSE),1:3]
#plot(dat_sample$x, dat_sample$y) #preview
result <- psim_real(n_events=2000, ppt=dat_sample,
start_date = NULL, poly = NULL, s_threshold = NULL,
step_length = 20, n_origin=50, resistance_feat, field=NA,
p_ratio=20, crsys = "EPSG:27700")
```



We are going to compare real (full) data and the simulated one in terms of their spatial and temporal characteristics. Recall that a user would have no idea of case count. So, the number to simulate is left to the discretion of the use. You can infer the potential size from any available data from previus years.


Note:
applications. Certain areas, only sparse data are availabe;... 
